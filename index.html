<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>小雨の世界</title>
  <style>
    :root{
      --pink0:#fff9fd;
      --pink1:#ffeef7;
      --pink2:#ffe0f0;
      --pink3:#f7c7df;

      --ink:#3a2231;
      --muted:#6c4a5f;

      --panel:#f8e6f1;
      --paper:#fff6fc;

      --b-dark:#2d1b27;
      --b-light:#ffffff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--ink);
      font-family:
        "Hiragino Maru Gothic ProN",
        "Hiragino Maru Gothic Pro",
        "Microsoft YaHei UI",
        "Microsoft YaHei",
        "PingFang SC",
        "Noto Sans SC",
        "Arial Rounded MT Bold",
        system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(255,224,240,.70) 0%, transparent 62%),
        radial-gradient(900px 600px at 80% 20%, rgba(185,240,255,.55) 0%, transparent 58%),
        linear-gradient(180deg, var(--pink2), var(--pink1) 45%, var(--pink0));
      overflow:auto;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,.00) 0px,
          rgba(255,255,255,.00) 3px,
          rgba(0,0,0,.018) 4px
        );
      mix-blend-mode:multiply;
      opacity:.10;
      pointer-events:none;
      z-index: 0;
    }

    body:after{
      content:"";
      position:fixed; inset:0;
      background:
        linear-gradient(90deg, rgba(255,255,255,.32) 50%, rgba(255,224,240,.22) 50%),
        linear-gradient(0deg,  rgba(255,255,255,.32) 50%, rgba(255,224,240,.22) 50%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 260 260'%3E%3Crect width='260' height='260' fill='none'/%3E%3Cg shape-rendering='crispEdges' opacity='0.88'%3E%3Cg transform='translate(24,24)'%3E%3Crect x='8' y='0' width='8' height='8' fill='%23d7a06a'/%3E%3Crect x='40' y='0' width='8' height='8' fill='%23d7a06a'/%3E%3Crect x='0' y='8' width='56' height='48' fill='%23e3b280'/%3E%3Crect x='8' y='16' width='40' height='32' fill='%23f4d3b6' opacity='0.55'/%3E%3Crect x='16' y='24' width='8' height='8' fill='%232d1b27'/%3E%3Crect x='32' y='24' width='8' height='8' fill='%232d1b27'/%3E%3Crect x='24' y='32' width='8' height='8' fill='%232d1b27'/%3E%3Crect x='20' y='40' width='16' height='8' fill='%23ffb5da'/%3E%3Crect x='0' y='8' width='56' height='48' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Crect x='8' y='0' width='8' height='8' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Crect x='40' y='0' width='8' height='8' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3Cg transform='translate(150,36)'%3E%3Crect x='0' y='24' width='64' height='40' fill='%23fff6fc'/%3E%3Crect x='0' y='16' width='64' height='12' fill='%23b9f0ff'/%3E%3Crect x='8' y='28' width='48' height='12' fill='%23ffe0f0'/%3E%3Crect x='12' y='44' width='40' height='12' fill='%23ffd36a' opacity='0.75'/%3E%3Crect x='28' y='8' width='8' height='8' fill='%23ff7cbc'/%3E%3Crect x='24' y='12' width='16' height='8' fill='%23ffb5da'/%3E%3Cpath d='M0 16h64v48H0z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Cpath d='M24 12h16v8H24zM28 8h8v8H28z' fill='none' stroke='%232d1b27' stroke-width='3'/%3E%3C/g%3E%3Cg transform='translate(72,160)'%3E%3Crect x='24' y='0' width='16' height='16' fill='%23ffb5da'/%3E%3Crect x='0' y='20' width='16' height='16' fill='%23ffb5da'/%3E%3Crect x='48' y='20' width='16' height='16' fill='%23ffb5da'/%3E%3Crect x='16' y='44' width='16' height='16' fill='%23ffb5da'/%3E%3Crect x='32' y='44' width='16' height='16' fill='%23ffb5da'/%3E%3Crect x='24' y='24' width='16' height='16' fill='%23fff6fc'/%3E%3Crect x='28' y='28' width='8' height='8' fill='%23ffd36a'/%3E%3Cpath d='M24 0h16v16H24zM0 20h16v16H0zM48 20h16v16H48zM16 44h16v16H16zM32 44h16v16H32z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Cpath d='M24 24h16v16H24z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3Cg opacity='0.55'%3E%3Cpath d='M210 190l2 6 6 2-6 2-2 6-2-6-6-2 6-2z' fill='%23ffffff'/%3E%3Cpath d='M34 208l2 6 6 2-6 2-2 6-2-6-6-2 6-2z' fill='%23ffffff'/%3E%3C/g%3E%3Ctext x='18' y='142' font-size='16' font-family='Arial Rounded MT Bold, sans-serif' fill='%23ff7cbc' opacity='0.45'%3E%25E3%2581%258B%25E3%2582%258F%25E3%2581%2584%25E3%2581%2584%25E2%2599%25A1%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-size: 44px 44px, 44px 44px, 260px 260px;
      background-position: 0 0, 0 0, 0 0;
      background-blend-mode: multiply;
      opacity: .62;
      pointer-events:none;
      z-index: 0;
    }

    .bgLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 1;
      overflow:hidden;
    }

    .bgText{
      position:absolute;
      inset:-12%;
      display:grid;
      place-items:center;
      opacity:.10;
      transform: rotate(-6deg);
      mix-blend-mode:multiply;
      user-select:none;
    }
    .bgText .t{
      font-weight: 900;
      letter-spacing: .18em;
      color: rgba(255, 124, 188, .55);
      text-shadow: 2px 2px 0 rgba(255,255,255,.64), -2px -2px 0 rgba(255,255,255,.36);
      line-height:1.05;
      text-align:center;
    }
    .bgText .t .small{
      display:block;
      font-size: clamp(18px, 3.0vw, 32px);
      opacity:.80;
      margin-top: 10px;
      letter-spacing: .22em;
    }
    .bgText .t .big{
      display:block;
      font-size: clamp(34px, 6.0vw, 70px);
    }

    .cornerDeco{
      position:absolute;
      width: 110px;
      height: 110px;
      opacity:.88;
      image-rendering: pixelated;
      filter: drop-shadow(0 10px 0 rgba(0,0,0,.08));
    }
    .cornerDeco.small{width: 86px;height: 86px;opacity:.82}
    .cornerDeco svg{width:100%;height:100%}

    .c1{left: 18px; top: 18px;}
    .c2{right: 20px; top: 20px;}
    .c3{left: 20px; bottom: 16px;}
    .c4{right: 18px; bottom: 14px;}

    .container{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px;
      padding: 16px 16px 22px;
      position:relative;
      z-index: 2;
    }

    .window{
      width:min(1120px, 96vw);
      height:min(700px, 72vh);
      background: var(--panel);
      border: 4px solid var(--b-dark);
      box-shadow: 0 0 0 2px var(--b-light), 0 0 0 6px rgba(0,0,0,.10), 0 16px 0 rgba(0,0,0,.14);
      display:flex;
      flex-direction:column;
      image-rendering: pixelated;
    }

    .titlebar{
      height: 58px;
      background: linear-gradient(180deg, #ffe0f0, #fff0f8);
      border-bottom: 4px solid var(--b-dark);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
    }

    .title-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .pixel-badge{
      width: 28px; height: 28px;
      background: #ff9dcf;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.78);
      display:grid; place-items:center;
      font-weight:900;
      color:#fff;
      line-height:1;
      user-select:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 14px;
    }

    .title-text{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .title-text b{font-size:13px;letter-spacing:.6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title-text span{font-size:11px;color:rgba(58,34,49,.72);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .hearts{display:flex;align-items:center;gap:6px;margin-left:10px;}
    .heart{
      width: 18px; height: 16px;
      background: #ff7cbc;
      border: 2px solid var(--b-dark);
      clip-path: polygon(50% 88%, 18% 58%, 8% 42%, 10% 28%, 22% 18%, 35% 20%, 44% 30%, 50% 38%, 56% 30%, 65% 20%, 78% 18%, 90% 28%, 92% 42%, 82% 58%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);
      opacity:.92;
    }

    .win-btns{display:flex;gap:8px;}
    .winbtn{
      width: 34px; height: 28px;
      background: #fff6fc;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      display:grid; place-items:center;
      user-select:none;
      opacity:.92;
    }
    .winbtn svg{width:16px;height:16px;stroke:var(--b-dark);stroke-width:2;fill:none;stroke-linecap:square}

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 270px 1fr;
      gap: 14px;
      padding: 14px;
      min-height: 0;
    }

    .side{
      background: rgba(255,255,255,.70);
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.78);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 0;
    }
    .side h3{margin:0;font-size:12px;letter-spacing:.6px;font-family: ui-monospace, Menlo, Consolas, monospace;}
    .stat{font-size:11px;color:rgba(58,34,49,.82);background:rgba(255,255,255,.78);border:2px solid rgba(45,27,39,.28);padding:8px 10px;line-height:1.6;}

    .btn{
      width:100%;
      background: #fff6fc;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      padding: 10px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .btn:hover{background:#fffaff}
    .btn:active{transform: translateY(1px)}
    .btn small{opacity:.75}
    .file{position:relative;overflow:hidden;}
    .file input{position:absolute;inset:0;opacity:0;cursor:pointer;}

    .search{
      width:100%;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      background: #fff;
      padding: 10px 10px;
      font-size: 12px;
      outline:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .search::placeholder{color: rgba(108,74,95,.58)}

    .hint{
      margin-top:auto;
      font-size: 10px;
      color: rgba(58,34,49,.74);
      line-height:1.7;
      background: rgba(255,255,255,.64);
      border: 2px dashed rgba(45,27,39,.28);
      padding: 8px 10px;
    }

    .stage{
      background: rgba(255,255,255,.70);
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.78);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height:0;
    }

    .chatTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 3px solid var(--b-dark);
      background:#fff6fc;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      font-size: 11px;
      letter-spacing:.4px;
      white-space:nowrap;
      user-select:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .chip .dot{
      width:10px; height:10px;
      background:#ff7cbc;
      border: 2px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);
    }

    .pad{display:flex;gap:10px;align-items:center;}
    .nav{
      width: 44px;
      height: 36px;
      border: 3px solid var(--b-dark);
      background:#fff;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
    }
    .nav:active{transform: translateY(1px)}
    .nav[disabled]{opacity:.4; cursor:not-allowed}
    .nav svg{width:18px;height:18px;stroke:var(--b-dark);stroke-width:3;fill:none;stroke-linecap:square;stroke-linejoin:miter}

    .bubbleWrap{flex:1;min-height:0;display:flex;align-items:stretch;}
    .bubble{
      width:100%;
      background: var(--paper);
      border: 4px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.84), 0 12px 0 rgba(0,0,0,.10);
      padding: 16px 16px 18px;
      position:relative;
      overflow:auto;
      image-rendering: pixelated;
      scrollbar-color: rgba(247,199,223,.85) rgba(255,255,255,.6);
      scrollbar-width: thin;
      transition: transform .22s steps(6), opacity .22s steps(6);
    }
    .bubble:after{
      content:"";
      position:absolute;
      left: 18px;
      bottom: -18px;
      width: 26px;
      height: 26px;
      background: var(--paper);
      border-left: 4px solid var(--b-dark);
      border-bottom: 4px solid var(--b-dark);
      transform: rotate(45deg);
      box-shadow: inset 2px -2px 0 rgba(255,255,255,.58);
    }

    .content{font-size:18px;line-height:1.9;letter-spacing:.22px;white-space:normal;word-break:break-word;}
    .content small{font-size:12px;color:rgba(108,74,95,.86);line-height:1.7;}

    .footer{
      height: 56px;
      background: rgba(255,255,255,.70);
      border-top: 4px solid var(--b-dark);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap: 12px;
    }

    .dots{display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:66%;overflow:hidden;}
    .dotbtn{width:10px;height:10px;border:2px solid var(--b-dark);background:rgba(255,255,255,.82);cursor:pointer;padding:0;}
    .dotbtn.active{background:#ff7cbc;box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);}

    .footerRight{
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
      font-size: 11px;
      color: rgba(58,34,49,.80);
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .mini{
      border: 3px solid var(--b-dark);
      background: #fff6fc;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
    }
    .mini:active{transform: translateY(1px)}

    .bubble.out-left{transform: translateX(-18px); opacity:0}
    .bubble.out-right{transform: translateX(18px); opacity:0}
    .bubble.in-left{transform: translateX(-18px); opacity:0}
    .bubble.in-right{transform: translateX(18px); opacity:0}

    .player{
      width:min(1120px, 96vw);
      background: rgba(255,255,255,.90);
      border: 3px solid rgba(45,27,39,.55);
      box-shadow: 0 14px 0 rgba(0,0,0,.08), 0 22px 34px rgba(0,0,0,.10);
      border-radius: 18px;
      padding: 8px 10px 10px;
      backdrop-filter: blur(6px);
    }

    .playerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 4px 6px 6px;
      flex-wrap:wrap;
    }

    .playerMeta{display:flex;flex-direction:column;gap:2px;min-width:240px;flex: 1 1 280px;}
    .playerMeta b{font-size:12px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .playerMeta span{font-size:10.5px;color:rgba(108,74,95,.82);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .playerBtns{display:flex;align-items:center;gap:10px;flex:0 0 auto;}

    .pbtn{
      width: 40px;
      height: 36px;
      border-radius: 12px;
      background: #fff6fc;
      border: 2px solid rgba(45,27,39,.55);
      box-shadow: 0 7px 0 rgba(0,0,0,.07);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
    }
    .pbtn:active{transform: translateY(1px)}
    .pbtn svg{width:18px;height:18px;fill:#ff7cbc;stroke:#ff7cbc;stroke-width:1.5}

    .pbtn.play{width:46px;height:40px;border-radius:999px;}
    .pbtn.play svg{width:20px;height:20px}

    .playerHearts{display:flex;gap:6px;align-items:center;flex:0 0 auto;}
    .pheart{
      width:14px;height:14px;background:#ffb5da;border:2px solid rgba(45,27,39,.55);
      clip-path: polygon(50% 88%, 18% 58%, 8% 42%, 10% 28%, 22% 18%, 35% 20%, 44% 30%, 50% 38%, 56% 30%, 65% 20%, 78% 18%, 90% 28%, 92% 42%, 82% 58%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.55);
      opacity:.92;
    }

    .importBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 14px;
      border: 2px solid rgba(45,27,39,.55);
      background: rgba(255,246,252,.96);
      cursor:pointer;
      user-select:none;
      font-size: 11px;
      box-shadow: 0 7px 0 rgba(0,0,0,.07);
      position:relative;
      overflow:hidden;
      white-space:nowrap;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      flex: 0 0 auto;
    }
    .importBtn:active{transform: translateY(1px)}
    .importBtn input{position:absolute;inset:0;opacity:0;cursor:pointer;}

    .autoplayInline{
      display:none;
      margin: 6px 6px 2px;
      padding: 7px 10px;
      border-radius: 14px;
      border: 2px solid rgba(45,27,39,.48);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      font-size: 11px;
      color: rgba(58,34,49,.90);
    }

    .progressRow{display:flex;align-items:center;gap:10px;padding:0 6px 2px;}
    .ptime{font-size:10.5px;color:rgba(108,74,95,.82);min-width:44px;text-align:center;font-family: ui-monospace, Menlo, Consolas, monospace;}
    .bar{
      position:relative;height:12px;flex:1;background:rgba(185,240,255,.70);
      border:2px solid rgba(45,27,39,.48);border-radius:999px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.58);
      cursor:pointer;
    }
    .barFill{position:absolute;left:0;top:0;bottom:0;width:0%;background:rgba(255,181,218,.90);border-radius:999px;}
    .starKnob{
      position:absolute;top:50%;left:0%;transform: translate(-50%, -50%);
      width:22px;height:22px;background:#ffe0f0;border:2px solid rgba(45,27,39,.55);
      border-radius:8px;clip-path: polygon(50% 5%, 61% 33%, 92% 36%, 68% 56%, 76% 88%, 50% 70%, 24% 88%, 32% 56%, 8% 36%, 39% 33%);
      box-shadow: 0 7px 0 rgba(0,0,0,.07), inset 0 0 0 2px rgba(255,255,255,.55);
      pointer-events:none;
    }

    .playerNote{
      margin: 2px 6px 0;
      font-size: 10.5px;
      color: rgba(108,74,95,.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    @media (max-width: 880px){
      .main{grid-template-columns: 1fr; }
      .side{order:2}
      .window{height: 78vh;}
      .bgText{opacity:.08;}
      .cornerDeco{display:none;}
      body:after{opacity:.55;}
    }
  </style>
</head>

<body>
  <div class="bgLayer" aria-hidden="true">
    <div class="bgText">
      <div class="t">
        <span class="big">Sweet Retro Diary</span>
        <span class="small">KUMA / CAKE / FLOWER / KAWAII</span>
      </div>
    </div>

    <div class="cornerDeco c1" aria-hidden="true">
      <svg viewBox="0 0 92 92" shape-rendering="crispEdges">
        <rect width="92" height="92" fill="none"/>
        <g>
          <rect x="18" y="10" width="10" height="10" fill="#d7a06a"/><rect x="64" y="10" width="10" height="10" fill="#d7a06a"/>
          <rect x="12" y="18" width="68" height="58" fill="#e3b280"/>
          <rect x="22" y="30" width="48" height="36" fill="#f4d3b6" opacity=".55"/>
          <rect x="30" y="40" width="8" height="8" fill="#2d1b27"/><rect x="54" y="40" width="8" height="8" fill="#2d1b27"/>
          <rect x="44" y="50" width="8" height="8" fill="#2d1b27"/>
          <rect x="38" y="60" width="16" height="8" fill="#ffb5da"/>
          <rect x="12" y="18" width="68" height="58" fill="none" stroke="#2d1b27" stroke-width="4"/>
          <rect x="18" y="10" width="10" height="10" fill="none" stroke="#2d1b27" stroke-width="4"/>
          <rect x="64" y="10" width="10" height="10" fill="none" stroke="#2d1b27" stroke-width="4"/>
        </g>
      </svg>
    </div>

    <div class="cornerDeco c2 small" aria-hidden="true">
      <svg viewBox="0 0 92 92" shape-rendering="crispEdges">
        <rect width="92" height="92" fill="none"/>
        <g>
          <rect x="14" y="34" width="64" height="44" fill="#fff6fc"/>
          <rect x="14" y="26" width="64" height="12" fill="#b9f0ff"/>
          <rect x="22" y="40" width="48" height="12" fill="#ffe0f0"/>
          <rect x="26" y="56" width="40" height="12" fill="#ffd36a" opacity=".75"/>
          <rect x="42" y="14" width="8" height="8" fill="#ff7cbc"/>
          <rect x="38" y="18" width="16" height="8" fill="#ffb5da"/>
          <rect x="14" y="26" width="64" height="52" fill="none" stroke="#2d1b27" stroke-width="4"/>
          <rect x="38" y="18" width="16" height="8" fill="none" stroke="#2d1b27" stroke-width="3"/>
          <rect x="42" y="14" width="8" height="8" fill="none" stroke="#2d1b27" stroke-width="3"/>
        </g>
      </svg>
    </div>

    <div class="cornerDeco c3 small" aria-hidden="true">
      <svg viewBox="0 0 92 92" shape-rendering="crispEdges">
        <rect width="92" height="92" fill="none"/>
        <g>
          <rect x="38" y="12" width="16" height="16" fill="#ffb5da"/>
          <rect x="14" y="34" width="16" height="16" fill="#ffb5da"/>
          <rect x="62" y="34" width="16" height="16" fill="#ffb5da"/>
          <rect x="30" y="58" width="16" height="16" fill="#ffb5da"/>
          <rect x="46" y="58" width="16" height="16" fill="#ffb5da"/>
          <rect x="38" y="38" width="16" height="16" fill="#fff6fc"/>
          <rect x="42" y="42" width="8" height="8" fill="#ffd36a"/>
          <path d="M38 12h16v16H38zM14 34h16v16H14zM62 34h16v16H62zM30 58h16v16H30zM46 58h16v16H46z" fill="none" stroke="#2d1b27" stroke-width="4"/>
          <rect x="38" y="38" width="16" height="16" fill="none" stroke="#2d1b27" stroke-width="4"/>
        </g>
      </svg>
    </div>

    <div class="cornerDeco c4" aria-hidden="true">
      <svg viewBox="0 0 92 92" shape-rendering="crispEdges">
        <rect width="92" height="92" fill="none"/>
        <g>
          <rect x="10" y="40" width="28" height="16" fill="#ffb5da"/>
          <rect x="12" y="42" width="24" height="12" fill="#fff6fc"/>
          <rect x="54" y="40" width="28" height="16" fill="#ffb5da"/>
          <rect x="56" y="42" width="24" height="12" fill="#fff6fc"/>
          <rect x="38" y="38" width="16" height="20" fill="#ff7cbc"/>
          <rect x="42" y="42" width="8" height="12" fill="#fff6fc"/>
          <path d="M10 40h28v16H10zM54 40h28v16H54zM38 38h16v20H38z" fill="none" stroke="#2d1b27" stroke-width="4"/>
        </g>
      </svg>
    </div>
  </div>

  <div class="container" id="dropZone">
    <div class="window" role="application" aria-label="说说卡片浏览器窗口">
      <div class="titlebar">
        <div class="title-left">
          <div class="pixel-badge">♡</div>
          <div class="title-text">
            <b>小雨の日记</b>
            <span>欢迎光临~</span>
          </div>
          <div class="hearts" aria-hidden="true"><div class="heart"></div><div class="heart"></div><div class="heart"></div></div>
        </div>

        <div class="win-btns" aria-hidden="true">
          <div class="winbtn" title="最小化"><svg viewBox="0 0 24 24"><path d="M6 18h12"/></svg></div>
          <div class="winbtn" title="最大化"><svg viewBox="0 0 24 24"><path d="M7 7h10v10H7z"/></svg></div>
          <div class="winbtn" title="关闭（装饰）"><svg viewBox="0 0 24 24"><path d="M7 7l10 10M17 7L7 17"/></svg></div>
        </div>
      </div>

      <div class="main">
        <aside class="side">
          <h3>CONTROL PANEL</h3>
          <div class="stat" id="stat">0 条</div>

          <div class="btn file" role="button" aria-label="导入txt">
            <span>导入 TXT（可选）</span><small>拖拽也行</small>
            <input type="file" id="file" accept=".txt,text/plain" />
          </div>

          <button class="btn" id="shuffle"><span>随机一条</span><small>R</small></button>
          <button class="btn" id="copy"><span>复制当前</span><small>COPY</small></button>

          <input class="search" id="search" placeholder="搜索内容 / 日期（回车确认）" />
          <button class="btn" id="clear"><span>清除搜索</span><small>CLEAR</small></button>

          <div class="hint" id="hint">
            Tips：<br>
            1) 放 data.txt 在同目录会自动读<br>
            2) 双击聊天框全屏<br>
            3) 底部小方块跳转<br>
            4) 音乐若被拦截：点一次播放
          </div>
        </aside>

        <section class="stage">
          <div class="chatTop">
            <div class="chip"><span class="dot" id="dot"></span><span id="date">正在加载 data.txt ...</span></div>
            <div class="pad">
              <button class="nav" id="prevBtn" aria-label="上一条"><svg viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6"/></svg></button>
              <div class="chip" id="index">—</div>
              <button class="nav" id="nextBtn" aria-label="下一条"><svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg></button>
            </div>
          </div>

          <div class="bubbleWrap">
            <div class="bubble" id="bubble" aria-live="polite">
              <div class="content" id="content">
                <small>
                  ✅ 自动读取同目录的 <b>data.txt</b><br>
                  ✅ 自动播放同目录的 <b>bgm.mp3</b><br><br>
                  如果你只是双击打开本地 html，部分浏览器会限制读取同目录文件；建议用 Live Server 或 python http.server 预览。
                </small>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">
        <div class="dots" id="dots" aria-label="进度"></div>
        <div class="footerRight">
          <div class="mini" id="fullscreen">全屏</div>
          <div style="opacity:.82">Kuma ✿ Cake ✿ Flower</div>
        </div>
      </div>
    </div>

    <div class="player" role="region" aria-label="背景音乐播放器">
      <div class="playerRow">
        <div class="playerMeta">
          <b id="trackName">BGM：正在加载 bgm.mp3 ...</b>
          <span id="trackHint">（可导入音频切换）</span>
        </div>

        <div class="playerBtns" aria-label="播放器控制">
          <div class="pbtn" id="prevTrack" title="上一首（导入多首时可用）">
            <svg viewBox="0 0 24 24"><path d="M7 6v12M18 6l-9 6 9 6z"/></svg>
          </div>

          <div class="pbtn play" id="togglePlay" title="播放 / 暂停（空格键也可以）">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M9 7l10 5-10 5z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M7 6h4v12H7zM13 6h4v12h-4z"/></svg>
          </div>

          <div class="pbtn" id="nextTrack" title="下一首（导入多首时可用）">
            <svg viewBox="0 0 24 24"><path d="M17 6v12M6 6l9 6-9 6z"/></svg>
          </div>

          <div class="playerHearts" aria-hidden="true"><div class="pheart"></div><div class="pheart"></div><div class="pheart"></div></div>
        </div>

        <label class="importBtn">
          导入音乐（可多选）
          <input type="file" id="audioFile" accept="audio/*" multiple />
        </label>
      </div>

      <div class="autoplayInline" id="autoplayInline">
        ⚠️ 浏览器可能会拦截“自动播放带声音”。点一次「播放」就好（之后通常会记住允许）。
      </div>

      <div class="progressRow">
        <div class="ptime" id="curTime">0:00</div>
        <div class="bar" id="bar">
          <div class="barFill" id="barFill"></div>
          <div class="starKnob" id="starKnob"></div>
        </div>
        <div class="ptime" id="durTime">0:00</div>
      </div>

      <div class="playerNote" id="playerNote">提示：把 bgm.mp3 放在同目录，会自动加载</div>
      <audio id="audio" preload="auto" loop></audio>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const els = {
      file: $("#file"),
      bubble: $("#bubble"),
      date: $("#date"),
      content: $("#content"),
      index: $("#index"),
      stat: $("#stat"),
      dots: $("#dots"),
      prev: $("#prevBtn"),
      next: $("#nextBtn"),
      shuffle: $("#shuffle"),
      copy: $("#copy"),
      search: $("#search"),
      clear: $("#clear"),
      fullscreen: $("#fullscreen"),
      dot: $("#dot"),
      hint: $("#hint"),
    };

    let entries = [];
    let view = [];
    let current = 0;

    function parseTxt(raw){
      const txt = String(raw || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n").trim();
      if(!txt) return [];

      const re = /(\d{4}年\d{1,2}月\d{1,2}日\s+\d{2}:\d{2}:\d{2})/g;
      const matches = [...txt.matchAll(re)];

      if(matches.length === 0){
        return txt
          .split(/\n{2,}/)
          .map(s => s.trim())
          .filter(Boolean)
          .map((body, i) => ({ id: i+1, date: "", body }));
      }

      const out = [];
      for(let i=0; i<matches.length; i++){
        const start = matches[i].index;
        const end = (i+1 < matches.length) ? matches[i+1].index : txt.length;
        const block = txt.slice(start, end).trim();
        const date = matches[i][1].trim();

        let body = block.replace(re, "").trim();
        body = body.replace(/^[\s\n]+/, "").replace(/[\s\n]+$/, "");
        out.push({ id: i+1, date, body });
      }
      return out;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function formatBody(body){
      const safe = escapeHTML(body);
      return safe.replaceAll("\n", "<br>");
    }

    function setStat(){
      els.stat.textContent = `${view.length} 条` + (entries.length !== view.length ? `（筛选自 ${entries.length} 条）` : "");
    }

    function buildDots(){
      els.dots.innerHTML = "";
      const maxDots = 70;
      const n = view.length;
      if(n <= 1) return;

      const count = Math.min(n, maxDots);
      for(let i=0; i<count; i++){
        const btn = document.createElement("button");
        btn.className = "dotbtn";
        btn.title = n <= maxDots ? `第 ${i+1} 条` : `跳转`;
        btn.addEventListener("click", () => {
          const target = (n <= maxDots) ? i : Math.round(i * (n-1) / (count-1));
          go(target, target > current ? "right" : "left");
        });
        els.dots.appendChild(btn);
      }
      updateDots();
    }

    function updateDots(){
      const dots = [...els.dots.querySelectorAll(".dotbtn")];
      if(!dots.length) return;

      const n = view.length;
      const maxDots = dots.length;
      let activeIdx = 0;
      if(n <= maxDots){
        activeIdx = current;
      }else{
        activeIdx = Math.round(current * (maxDots-1) / (n-1));
      }
      dots.forEach((d, i) => d.classList.toggle("active", i === activeIdx));
    }

    function setNavState(){
      const disabled = view.length <= 1;
      els.prev.toggleAttribute("disabled", disabled);
      els.next.toggleAttribute("disabled", disabled);
    }

    function pickDotColor(date){
      const s = date || "no-date";
      let h = 0;
      for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
      const hue = (h % 360);
      els.dot.style.background = `hsla(${hue}, 68%, 64%, .95)`;
    }

    function render(direction){
      if(view.length === 0){
        els.date.textContent = "没有可展示的记录";
        els.index.textContent = "—";
        els.content.innerHTML = "<small>没读到 data.txt：请把 data.txt 放在同目录，或点击左侧导入 txt。</small>";
        els.dots.innerHTML = "";
        setNavState();
        setStat();
        return;
      }

      const item = view[current];
      setNavState();
      setStat();

      const outClass = direction === "right" ? "out-left" : direction === "left" ? "out-right" : "";
      const inClass  = direction === "right" ? "in-right"  : direction === "left" ? "in-left"  : "";

      if(outClass) els.bubble.classList.add(outClass);

      window.setTimeout(() => {
        els.date.textContent = item.date || "（无时间戳）";
        els.index.textContent = `${current + 1} / ${view.length}`;
        els.content.innerHTML = formatBody(item.body || "（空）");
        pickDotColor(item.date);
        updateDots();
        els.bubble.scrollTop = 0;

        if(outClass){
          els.bubble.classList.remove(outClass);
          els.bubble.classList.add(inClass);
          window.requestAnimationFrame(() => els.bubble.classList.remove(inClass));
        }
      }, outClass ? 90 : 0);
    }

    function go(idx, direction){
      if(view.length === 0) return;
      current = (idx + view.length) % view.length;
      render(direction);
    }
    function next(){ go(current + 1, "right"); }
    function prev(){ go(current - 1, "left"); }

    function applyFilter(q){
      const query = (q || "").trim().toLowerCase();
      if(!query){
        view = [...entries];
        current = Math.min(current, view.length - 1);
        buildDots();
        render();
        return;
      }
      view = entries.filter(e => (e.date + "\n" + e.body).toLowerCase().includes(query));
      current = 0;
      buildDots();
      render();
    }

    async function loadTxtFile(file){
      const text = await file.text();
      entries = parseTxt(text);
      view = [...entries];
      current = 0;
      buildDots();
      render();
      els.hint.innerHTML = `已导入：<b>${escapeHTML(file.name)}</b><br>共 ${entries.length} 条`;
    }

    async function loadTxtFromUrl(url){
      try{
        const res = await fetch(url, { cache: "no-cache" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        entries = parseTxt(text);
        view = [...entries];
        current = 0;
        buildDots();
        render();
        els.hint.innerHTML = `已自动读取：<b>${escapeHTML(url)}</b><br>共 ${entries.length} 条`;
      }catch{
        els.date.textContent = "没有找到 data.txt";
        els.index.textContent = "—";
        els.content.innerHTML = "<small>我没能自动读取同目录的 <b>data.txt</b>。<br>解决：把你的 txt 文件命名为 <b>data.txt</b> 放在同目录，或用左侧按钮手动导入。</small>";
        setStat();
      }
    }

    els.file.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) await loadTxtFile(file);
      e.target.value = "";
    });

    ["dragenter","dragover"].forEach(evt => {
      document.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    document.addEventListener("drop", async (e) => {
      e.preventDefault(); e.stopPropagation();
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!file) return;
      if(file.type.startsWith("text/") || file.name.toLowerCase().endsWith(".txt")){
        await loadTxtFile(file);
      }
    });

    els.prev.addEventListener("click", prev);
    els.next.addEventListener("click", next);
    els.shuffle.addEventListener("click", () => {
      if(view.length <= 1) return;
      const r = Math.floor(Math.random() * view.length);
      go(r, r > current ? "right" : "left");
    });

    els.copy.addEventListener("click", async () => {
      if(view.length === 0) return;
      const item = view[current];
      const text = (item.date ? item.date + "\n" : "") + item.body;
      try{
        await navigator.clipboard.writeText(text);
        els.hint.textContent = "已复制当前内容♡";
      }catch{
        els.hint.textContent = "复制失败：浏览器限制（可手动选中复制）";
      }
      setTimeout(() => {
        els.hint.innerHTML = "Tips：<br>1) 放 data.txt 在同目录会自动读<br>2) 双击聊天框全屏<br>3) 底部小方块跳转<br>4) 音乐若被拦截：点一次播放";
      }, 1400);
    });

    els.search.addEventListener("keydown", (e) => {
      if(e.key === "Enter") applyFilter(els.search.value);
    });
    els.clear.addEventListener("click", () => {
      els.search.value = "";
      applyFilter("");
    });

    async function toggleFullscreen(){
      try{
        const win = document.querySelector(".window");
        if(!document.fullscreenElement) await win.requestFullscreen();
        else await document.exitFullscreen();
      }catch{}
    }
    els.fullscreen.addEventListener("click", toggleFullscreen);
    els.bubble.addEventListener("dblclick", toggleFullscreen);

    window.addEventListener("keydown", (e) => {
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key === "Escape" && document.fullscreenElement) document.exitFullscreen();
      if(e.key.toLowerCase() === "r") { e.preventDefault(); els.shuffle.click(); }
      if(e.key === " "){ e.preventDefault(); $("#togglePlay").click(); }
    });

    let startX = 0, startY = 0, moved = false;
    els.bubble.addEventListener("pointerdown", (e) => {
      startX = e.clientX; startY = e.clientY; moved = false;
      els.bubble.setPointerCapture(e.pointerId);
    });
    els.bubble.addEventListener("pointermove", (e) => {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if(Math.abs(dx) > 12 && Math.abs(dx) > Math.abs(dy)) moved = true;
    });
    els.bubble.addEventListener("pointerup", (e) => {
      const dx = e.clientX - startX;
      if(!moved) return;
      if(dx < -55) next();
      if(dx > 55) prev();
    });

    // ======= Music player =======
    const audio = $("#audio");
    const audioFile = $("#audioFile");
    const togglePlayBtn = $("#togglePlay");
    const playIcon = $("#playIcon");
    const pauseIcon = $("#pauseIcon");
    const prevTrackBtn = $("#prevTrack");
    const nextTrackBtn = $("#nextTrack");
    const bar = $("#bar");
    const barFill = $("#barFill");
    const starKnob = $("#starKnob");
    const curTime = $("#curTime");
    const durTime = $("#durTime");
    const trackName = $("#trackName");
    const trackHint = $("#trackHint");
    const playerNote = $("#playerNote");
    const autoplayInline = $("#autoplayInline");

    let playlist = [];
    let trackIndex = 0;

    function fmtTime(sec){
      if(!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function setPlayingUI(isPlaying){
      playIcon.style.display = isPlaying ? "none" : "block";
      pauseIcon.style.display = isPlaying ? "block" : "none";
    }

    async function tryPlay(){
      try{
        const p = audio.play();
        if(p && p.then) await p;
        setPlayingUI(true);
        autoplayInline.style.display = "none";
      }catch{
        setPlayingUI(false);
        autoplayInline.style.display = "block";
      }
    }

    async function loadAudioFiles(files){
      playlist.forEach(t => { if(t.url && t.url.startsWith("blob:")) URL.revokeObjectURL(t.url); });
      playlist = files.map(f => ({ name: f.name, url: URL.createObjectURL(f) }));
      trackIndex = 0;
      audio.src = playlist[0].url;
      audio.loop = true;
      trackName.textContent = "BGM：" + playlist[0].name;
      trackHint.textContent = (playlist.length > 1) ? `第 1/${playlist.length} 首（可切换）` : "点击播放/暂停即可";
      playerNote.textContent = "空格键播放/暂停 · 点击进度条跳转";
      await tryPlay();
    }

    audioFile.addEventListener("change", async (e) => {
      const files = [...(e.target.files || [])].filter(f => f.type.startsWith("audio/"));
      if(files.length) await loadAudioFiles(files);
      e.target.value = "";
    });

    function loadTrack(i, autoplay=true){
      if(!playlist.length) return;
      trackIndex = (i + playlist.length) % playlist.length;
      const t = playlist[trackIndex];
      audio.src = t.url;
      audio.loop = true;
      trackName.textContent = "BGM：" + t.name;
      trackHint.textContent = (playlist.length > 1) ? `第 ${trackIndex+1}/${playlist.length} 首（可切换）` : "点击播放/暂停即可";
      if(autoplay) tryPlay();
    }

    togglePlayBtn.addEventListener("click", async () => {
      if(!audio.src) audio.src = "bgm.mp3";
      if(audio.paused) await tryPlay();
      else { audio.pause(); setPlayingUI(false); }
    });

    prevTrackBtn.addEventListener("click", () => { if(playlist.length > 1) loadTrack(trackIndex - 1, true); });
    nextTrackBtn.addEventListener("click", () => { if(playlist.length > 1) loadTrack(trackIndex + 1, true); });

    audio.addEventListener("timeupdate", () => {
      const cur = audio.currentTime || 0;
      const dur = audio.duration || 0;
      curTime.textContent = fmtTime(cur);
      durTime.textContent = isFinite(dur) ? fmtTime(dur) : "0:00";
      const p = (dur > 0) ? (cur / dur) : 0;
      barFill.style.width = (p * 100) + "%";
      starKnob.style.left = (p * 100) + "%";
    });

    function seekByClientX(clientX){
      const rect = bar.getBoundingClientRect();
      const x = Math.min(rect.right, Math.max(rect.left, clientX));
      const p = (x - rect.left) / rect.width;
      const dur = audio.duration || 0;
      if(dur > 0) audio.currentTime = p * dur;
    }
    bar.addEventListener("click", (e) => seekByClientX(e.clientX));

    async function tryLoadDefaultBgm(){
      audio.src = "bgm.mp3";
      audio.loop = true;
      trackName.textContent = "BGM：bgm.mp3（默认）";
      trackHint.textContent = "若被浏览器拦截自动播放，点一次播放即可";
      playerNote.textContent = "你也可以导入自己的音频替换/切歌";
      await tryPlay();
    }

    audio.addEventListener("error", () => {
      if(audio.src && audio.src.endsWith("bgm.mp3") && !playlist.length){
        trackName.textContent = "BGM：未找到 bgm.mp3";
        trackHint.textContent = "把音频放同目录并命名 bgm.mp3，或点“导入音乐”";
        playerNote.textContent = "说明：GitHub Pages 上同目录文件可直接引用";
        setPlayingUI(false);
      }
    });

    render();
    loadTxtFromUrl("data.txt");
    tryLoadDefaultBgm();
  </script>
</body>
</html>
