<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¯´è¯´å¡ç‰‡æµè§ˆå™¨ Â· æµ…ç²‰å¤å¤åƒç´ ï¼ˆè‡ªå¸¦TXT+éŸ³ä¹ï¼‰</title>
  <style>
    :root{
      /* lighter, airier pinks */
      --pink0:#fff8fc;
      --pink1:#ffe7f3;
      --pink2:#ffd7ec;
      --pink3:#f4b8d7;

      --ink:#3a2231;
      --muted:#6c4a5f;

      --panel:#f7e2ee;
      --paper:#fff4fb;

      --b-dark:#2d1b27;
      --b-light:#ffffff;

      --shadow: rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--ink);
      font-family:
        "Hiragino Maru Gothic ProN",
        "Hiragino Maru Gothic Pro",
        "Microsoft YaHei UI",
        "Microsoft YaHei",
        "PingFang SC",
        "Noto Sans SC",
        "Arial Rounded MT Bold",
        system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(255,210,233,.75) 0%, transparent 62%),
        radial-gradient(900px 600px at 80% 20%, rgba(185,240,255,.65) 0%, transparent 58%),
        linear-gradient(180deg, var(--pink2), var(--pink1) 45%, var(--pink0));
      overflow:auto;
    }

    /* scanlines + tiny dithering (lighter) */
    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,.00) 0px,
          rgba(255,255,255,.00) 3px,
          rgba(0,0,0,.02) 4px
        ),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='90' height='90'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='1' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='90' height='90' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      mix-blend-mode:multiply;
      opacity:.10;
      pointer-events:none;
      z-index: 0;
    }

    /* pastel checkers + paw prints + tiny hearts/sparkles */
    body:after{
      content:"";
      position:fixed; inset:0;
      background:
        /* subtle checkers */
        linear-gradient(90deg, rgba(255,255,255,.30) 50%, rgba(255,215,236,.22) 50%),
        linear-gradient(0deg,  rgba(255,255,255,.30) 50%, rgba(255,215,236,.22) 50%),
        /* paws + doodles */
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cg opacity='0.16'%3E%3Cg fill='%23ff6fb5'%3E%3Ccircle cx='30' cy='30' r='6'/%3E%3Ccircle cx='46' cy='24' r='6'/%3E%3Ccircle cx='62' cy='30' r='6'/%3E%3Ccircle cx='44' cy='46' r='10'/%3E%3C/g%3E%3C/g%3E%3Cg opacity='0.12'%3E%3Cg fill='%2388dff3'%3E%3Ccircle cx='96' cy='96' r='6'/%3E%3Ccircle cx='112' cy='90' r='6'/%3E%3Ccircle cx='128' cy='96' r='6'/%3E%3Ccircle cx='110' cy='112' r='10'/%3E%3C/g%3E%3C/g%3E%3Cg opacity='0.10'%3E%3Cpath d='M88 22l6 6-6 6-6-6z' fill='%23ff9ad0'/%3E%3Cpath d='M20 104h10v10H20z' fill='%23b9f0ff'/%3E%3Cpath d='M60 120c6-10 18-10 24 0-10 6-14 6-24 0z' fill='%23ffd7ec'/%3E%3C/g%3E%3Cg opacity='0.10'%3E%3Cpath d='M18 72c3-6 10-6 13 0-5 3-8 3-13 0z' fill='%23ff9ad0'/%3E%3Cpath d='M110 44c3-6 10-6 13 0-5 3-8 3-13 0z' fill='%23b9f0ff'/%3E%3Cpath d='M72 18l2 6 6 2-6 2-2 6-2-6-6-2 6-2z' fill='%23fff' opacity='.7'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 44px 44px, 44px 44px, 140px 140px;
      background-position: 0 0, 0 0, 0 0;
      background-blend-mode: multiply;
      opacity: .60;
      pointer-events:none;
      z-index: 0;
    }

    .bgLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 1;
      overflow:hidden;
    }

    /* decorative text only */
    .bgText{
      position:absolute;
      inset:-10%;
      display:grid;
      place-items:center;
      opacity:.14;
      transform: rotate(-8deg);
      mix-blend-mode:multiply;
      filter: saturate(1.05);
      user-select:none;
    }
    .bgText .t{
      font-weight: 900;
      letter-spacing: .18em;
      color: rgba(255, 95, 162, .52);
      text-shadow:
        2px 2px 0 rgba(255,255,255,.60),
        -2px -2px 0 rgba(255,255,255,.35);
      line-height:1.05;
      text-align:center;
    }
    .bgText .t .small{
      display:block;
      font-size: clamp(18px, 3.0vw, 34px);
      opacity:.84;
      margin-top: 10px;
      letter-spacing: .22em;
    }
    .bgText .t .big{
      display:block;
      font-size: clamp(36px, 6.2vw, 74px);
    }

    /* stickers */
    .sticker{
      position:absolute;
      width: 68px;
      height: 68px;
      image-rendering: pixelated;
      opacity:.90;
      filter: drop-shadow(0 8px 0 rgba(0,0,0,.09));
      transform: rotate(var(--rot));
      will-change: transform;
    }
    .sprite{width:100%;height:100%;background-position:center;background-size:contain;background-repeat:no-repeat;}

    /* pixel icon set (more kinds) */
    .i-star{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='34' y='8' width='24' height='8' fill='%23fff2fb'/%3E%3Crect x='30' y='16' width='32' height='8' fill='%23ff7cbc'/%3E%3Crect x='26' y='24' width='40' height='8' fill='%23fff2fb'/%3E%3Crect x='18' y='32' width='56' height='8' fill='%23ffb5da'/%3E%3Crect x='10' y='40' width='72' height='8' fill='%23fff2fb'/%3E%3Crect x='18' y='48' width='56' height='8' fill='%23ff7cbc'/%3E%3Crect x='26' y='56' width='40' height='8' fill='%23fff2fb'/%3E%3Crect x='34' y='64' width='24' height='8' fill='%23ffb5da'/%3E%3Crect x='38' y='72' width='16' height='8' fill='%23fff2fb'/%3E%3Crect x='22' y='34' width='48' height='24' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-bow{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='10' y='38' width='26' height='16' fill='%23ffb5da'/%3E%3Crect x='12' y='40' width='22' height='12' fill='%23fff2fb'/%3E%3Crect x='56' y='38' width='26' height='16' fill='%23ffb5da'/%3E%3Crect x='58' y='40' width='22' height='12' fill='%23fff2fb'/%3E%3Crect x='38' y='36' width='16' height='20' fill='%23ff7cbc'/%3E%3Crect x='42' y='40' width='8' height='12' fill='%23fff2fb'/%3E%3Cpath d='M10 38h26v16H10zM56 38h26v16H56zM38 36h16v20H38z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-cassette{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='14' y='22' width='64' height='48' fill='%23fff4fb'/%3E%3Crect x='18' y='26' width='56' height='18' fill='%23ffd7ec'/%3E%3Crect x='22' y='30' width='14' height='10' fill='%23b9f0ff'/%3E%3Crect x='56' y='30' width='14' height='10' fill='%23b9f0ff'/%3E%3Crect x='26' y='50' width='40' height='16' fill='%23fff'/%3E%3Cpath d='M14 22h64v48H14z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Cpath d='M18 26h56v18H18zM26 50h40v16H26z' fill='none' stroke='%232d1b27' stroke-width='3'/%3E%3C/g%3E%3C/svg%3E");}
    .i-paw{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='18' y='22' width='10' height='10' fill='%23ff7cbc'/%3E%3Crect x='30' y='16' width='10' height='10' fill='%23ff7cbc'/%3E%3Crect x='42' y='22' width='10' height='10' fill='%23ff7cbc'/%3E%3Crect x='28' y='32' width='14' height='16' fill='%23ffb5da'/%3E%3Crect x='26' y='30' width='18' height='20' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3Cpath d='M18 22h10v10H18zM30 16h10v10H30zM42 22h10v10H42z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-sakura{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='40' y='18' width='12' height='12' fill='%23ffb5da'/%3E%3Crect x='26' y='30' width='12' height='12' fill='%23ffb5da'/%3E%3Crect x='54' y='30' width='12' height='12' fill='%23ffb5da'/%3E%3Crect x='34' y='44' width='24' height='20' fill='%23fff4fb'/%3E%3Crect x='40' y='48' width='12' height='12' fill='%23ffd7ec'/%3E%3Cpath d='M40 18h12v12H40zM26 30h12v12H26zM54 30h12v12H54zM34 44h24v20H34z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-gummy{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='18' y='26' width='56' height='40' rx='8' ry='8' fill='%23b9f0ff'/%3E%3Crect x='22' y='30' width='48' height='32' fill='%23fff4fb' opacity='0.55'/%3E%3Cpath d='M18 26h56v40H18z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}

    .i-heart{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='22' y='22' width='12' height='12' fill='%23ff7cbc'/%3E%3Crect x='58' y='22' width='12' height='12' fill='%23ff7cbc'/%3E%3Crect x='18' y='34' width='56' height='12' fill='%23ffb5da'/%3E%3Crect x='22' y='46' width='48' height='12' fill='%23ffb5da'/%3E%3Crect x='30' y='58' width='32' height='12' fill='%23ff7cbc'/%3E%3Cpath d='M22 22h12v12H22zM58 22h12v12H58zM18 34h56v12H18zM22 46h48v12H22zM30 58h32v12H30z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-lightning{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='44' y='14' width='14' height='10' fill='%23fff'/%3E%3Crect x='36' y='24' width='18' height='10' fill='%23ffe06f'/%3E%3Crect x='40' y='34' width='16' height='10' fill='%23ffe06f'/%3E%3Crect x='30' y='44' width='22' height='10' fill='%23ffe06f'/%3E%3Crect x='34' y='54' width='18' height='10' fill='%23fff'/%3E%3Crect x='28' y='64' width='22' height='10' fill='%23ffe06f'/%3E%3Cpath d='M36 24h18v10H36zM40 34h16v10H40zM30 44h22v10H30zM28 64h22v10H28z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-candy{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='18' y='40' width='14' height='12' fill='%23b9f0ff'/%3E%3Crect x='60' y='40' width='14' height='12' fill='%23b9f0ff'/%3E%3Crect x='30' y='34' width='32' height='24' fill='%23fff4fb'/%3E%3Crect x='34' y='38' width='24' height='16' fill='%23ffd7ec'/%3E%3Cpath d='M18 40h14v12H18zM60 40h14v12H60zM30 34h32v24H30z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-cd{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='22' y='22' width='48' height='48' fill='%23fff4fb'/%3E%3Crect x='30' y='30' width='32' height='32' fill='%23b9f0ff' opacity='.75'/%3E%3Crect x='40' y='40' width='12' height='12' fill='%23ffd7ec'/%3E%3Cpath d='M22 22h48v48H22zM30 30h32v32H30zM40 40h12v12H40z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-strawberry{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='40' y='18' width='12' height='10' fill='%2382e59b'/%3E%3Crect x='34' y='28' width='24' height='10' fill='%23ff7cbc'/%3E%3Crect x='30' y='38' width='32' height='22' fill='%23ffb5da'/%3E%3Crect x='34' y='60' width='24' height='10' fill='%23ff7cbc'/%3E%3Crect x='36' y='44' width='4' height='4' fill='%23fff'/%3E%3Crect x='46' y='50' width='4' height='4' fill='%23fff'/%3E%3Crect x='52' y='44' width='4' height='4' fill='%23fff'/%3E%3Cpath d='M40 18h12v10H40zM34 28h24v10H34zM30 38h32v22H30zM34 60h24v10H34z' fill='none' stroke='%232d1b27' stroke-width='4'/%3E%3C/g%3E%3C/svg%3E");}
    .i-sparkle{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='92' height='92' viewBox='0 0 92 92'%3E%3Crect width='92' height='92' fill='none'/%3E%3Cg shape-rendering='crispEdges'%3E%3Crect x='44' y='14' width='4' height='18' fill='%23fff'/%3E%3Crect x='38' y='30' width='16' height='4' fill='%23fff'/%3E%3Crect x='44' y='34' width='4' height='18' fill='%23b9f0ff'/%3E%3Crect x='38' y='50' width='16' height='4' fill='%23b9f0ff'/%3E%3Crect x='22' y='62' width='10' height='10' fill='%23ffb5da'/%3E%3Crect x='60' y='60' width='12' height='12' fill='%23ffd7ec'/%3E%3Cpath d='M44 14h4v18h-4zM38 30h16v4H38zM44 34h4v18h-4zM38 50h16v4H38z' fill='none' stroke='%232d1b27' stroke-width='3'/%3E%3C/g%3E%3C/svg%3E");}

    .container{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px; /* clear spacing between window and player */
      padding: 16px 16px 22px;
      position:relative;
      z-index: 2;
    }

    /* pixel window */
    .window{
      width:min(1120px, 96vw);
      height:min(700px, 72vh); /* keep slightly smaller */
      background: var(--panel);
      border: 4px solid var(--b-dark);
      box-shadow:
        0 0 0 2px var(--b-light),
        0 0 0 6px rgba(0,0,0,.12),
        0 16px 0 rgba(0,0,0,.16);
      display:flex;
      flex-direction:column;
      image-rendering: pixelated;
    }

    .titlebar{
      height: 58px;
      background: linear-gradient(180deg, #ffd6eb, #ffe7f3);
      border-bottom: 4px solid var(--b-dark);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
    }

    .title-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .pixel-badge{
      width: 28px; height: 28px;
      background: #ff8cc5;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.72);
      display:grid; place-items:center;
      font-weight:900;
      color:#fff;
      line-height:1;
      user-select:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 14px;
    }

    .title-text{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .title-text b{
      font-size: 13px;
      letter-spacing: .6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title-text span{
      font-size: 11px;
      color: rgba(58,34,49,.74);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .hearts{display:flex;align-items:center;gap:6px;margin-left:10px;}
    .heart{
      width: 18px; height: 16px;
      background: #ff7cbc;
      border: 2px solid var(--b-dark);
      clip-path: polygon(50% 88%, 18% 58%, 8% 42%, 10% 28%, 22% 18%, 35% 20%, 44% 30%, 50% 38%, 56% 30%, 65% 20%, 78% 18%, 90% 28%, 92% 42%, 82% 58%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);
      opacity:.92;
    }

    .win-btns{display:flex;gap:8px;}
    .winbtn{
      width: 34px; height: 28px;
      background: #fff3fa;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.78);
      display:grid; place-items:center;
      user-select:none;
      opacity:.92;
    }
    .winbtn svg{width:16px;height:16px;stroke:var(--b-dark);stroke-width:2;fill:none;stroke-linecap:square}

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 270px 1fr;
      gap: 14px;
      padding: 14px;
      min-height: 0;
    }

    .side{
      background: rgba(255,255,255,.68);
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.74);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 0;
    }
    .side h3{
      margin:0;
      font-size: 12px;
      letter-spacing:.6px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .stat{
      font-size: 11px;
      color: rgba(58,34,49,.82);
      background: rgba(255,255,255,.78);
      border: 2px solid rgba(45,27,39,.30);
      padding: 8px 10px;
      line-height: 1.6;
    }
    .btn{
      width:100%;
      background: #fff2fa;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      padding: 10px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .btn:hover{background:#fff7fc}
    .btn:active{transform: translateY(1px)}
    .btn small{opacity:.75}

    .file{position:relative;overflow:hidden;}
    .file input{position:absolute;inset:0;opacity:0;cursor:pointer;}

    .search{
      width:100%;
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.78);
      background: #fff;
      padding: 10px 10px;
      font-size: 12px;
      outline:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .search::placeholder{color: rgba(108,74,95,.60)}

    .hint{
      margin-top:auto;
      font-size: 10px;
      color: rgba(58,34,49,.74);
      line-height:1.7;
      background: rgba(255,255,255,.62);
      border: 2px dashed rgba(45,27,39,.30);
      padding: 8px 10px;
    }

    .stage{
      background: rgba(255,255,255,.68);
      border: 3px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.74);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height:0;
    }

    .chatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 3px solid var(--b-dark);
      background:#fff2fa;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      font-size: 11px;
      letter-spacing:.4px;
      white-space:nowrap;
      user-select:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .chip .dot{
      width:10px; height:10px;
      background:#ff7cbc;
      border: 2px solid var(--b-dark);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);
    }

    .pad{display:flex;gap:10px;align-items:center;}
    .nav{
      width: 44px;
      height: 36px;
      border: 3px solid var(--b-dark);
      background:#fff;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
    }
    .nav:active{transform: translateY(1px)}
    .nav[disabled]{opacity:.4; cursor:not-allowed}
    .nav svg{width:18px;height:18px;stroke:var(--b-dark);stroke-width:3;fill:none;stroke-linecap:square;stroke-linejoin:miter}

    .bubbleWrap{flex:1;min-height:0;display:flex;align-items:stretch;}
    .bubble{
      width:100%;
      background: var(--paper);
      border: 4px solid var(--b-dark);
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.84),
        0 12px 0 rgba(0,0,0,.10);
      padding: 16px 16px 18px;
      position:relative;
      overflow:auto;
      image-rendering: pixelated;
      scrollbar-color: rgba(244,184,215,.85) rgba(255,255,255,.6);
      scrollbar-width: thin;
      transition: transform .22s steps(6), opacity .22s steps(6);
    }
    .bubble:after{
      content:"";
      position:absolute;
      left: 18px;
      bottom: -18px;
      width: 26px;
      height: 26px;
      background: var(--paper);
      border-left: 4px solid var(--b-dark);
      border-bottom: 4px solid var(--b-dark);
      transform: rotate(45deg);
      box-shadow: inset 2px -2px 0 rgba(255,255,255,.58);
    }

    .content{
      font-size: 18px;
      line-height: 1.9;
      letter-spacing: .22px;
      white-space: normal;
      word-break: break-word;
    }
    .content small{
      font-size: 12px;
      color: rgba(108,74,95,.86);
      line-height: 1.7;
    }

    .footer{
      height: 56px;
      background: rgba(255,255,255,.68);
      border-top: 4px solid var(--b-dark);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap: 12px;
    }
    .dots{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      max-width: 66%;
      overflow:hidden;
    }
    .dotbtn{
      width: 10px;
      height: 10px;
      border: 2px solid var(--b-dark);
      background: rgba(255,255,255,.82);
      cursor:pointer;
      padding:0;
    }
    .dotbtn.active{
      background: #ff7cbc;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.48);
    }
    .footerRight{
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
      font-size: 11px;
      color: rgba(58,34,49,.80);
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .mini{
      border: 3px solid var(--b-dark);
      background: #fff2fa;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
    }
    .mini:active{transform: translateY(1px)}

    .bubble.out-left{transform: translateX(-18px); opacity:0}
    .bubble.out-right{transform: translateX(18px); opacity:0}
    .bubble.in-left{transform: translateX(-18px); opacity:0}
    .bubble.in-right{transform: translateX(18px); opacity:0}

    /* ==== PLAYER: long bar, slimmer ==== */
    .player{
      width:min(1120px, 96vw); /* same as window */
      background: rgba(255,255,255,.88);
      border: 3px solid rgba(45,27,39,.58);
      box-shadow:
        0 14px 0 rgba(0,0,0,.08),
        0 22px 34px rgba(0,0,0,.10);
      border-radius: 18px;
      padding: 8px 10px 10px;
      backdrop-filter: blur(6px);
    }

    .playerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 4px 6px 6px;
      flex-wrap:wrap;
    }

    .playerMeta{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 240px;
      flex: 1 1 280px;
    }
    .playerMeta b{
      font-size: 12px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .playerMeta span{
      font-size: 10.5px;
      color: rgba(108,74,95,.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .playerBtns{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .pbtn{
      width: 40px;
      height: 36px;
      border-radius: 12px;
      background: #fff2fa;
      border: 2px solid rgba(45,27,39,.58);
      box-shadow: 0 7px 0 rgba(0,0,0,.07);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
    }
    .pbtn:active{transform: translateY(1px)}
    .pbtn svg{width:18px;height:18px;fill:#ff7cbc;stroke:#ff7cbc;stroke-width:1.5}

    .pbtn.play{
      width: 46px;
      height: 40px;
      border-radius: 999px;
    }
    .pbtn.play svg{width:20px;height:20px}

    .playerHearts{display:flex; gap:6px; align-items:center; flex:0 0 auto;}
    .pheart{
      width: 14px; height: 14px;
      background: #ffb5da;
      border: 2px solid rgba(45,27,39,.58);
      clip-path: polygon(50% 88%, 18% 58%, 8% 42%, 10% 28%, 22% 18%, 35% 20%, 44% 30%, 50% 38%, 56% 30%, 65% 20%, 78% 18%, 90% 28%, 92% 42%, 82% 58%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.55);
      opacity:.92;
    }

    .importBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 14px;
      border: 2px solid rgba(45,27,39,.58);
      background: rgba(255,242,250,.96);
      cursor:pointer;
      user-select:none;
      font-size: 11px;
      box-shadow: 0 7px 0 rgba(0,0,0,.07);
      position:relative;
      overflow:hidden;
      white-space:nowrap;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      flex: 0 0 auto;
    }
    .importBtn:active{transform: translateY(1px)}
    .importBtn input{position:absolute;inset:0;opacity:0;cursor:pointer;}

    .autoplayInline{
      display:none;
      margin: 6px 6px 2px;
      padding: 7px 10px;
      border-radius: 14px;
      border: 2px solid rgba(45,27,39,.50);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      font-size: 11px;
      color: rgba(58,34,49,.90);
    }

    .progressRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 6px 2px;
    }
    .ptime{
      font-size: 10.5px;
      color: rgba(108,74,95,.82);
      min-width: 44px;
      text-align:center;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .bar{
      position:relative;
      height: 12px;
      flex: 1;
      background: rgba(185,240,255,.70);
      border: 2px solid rgba(45,27,39,.50);
      border-radius: 999px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.58);
      cursor:pointer;
    }
    .barFill{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 0%;
      background: rgba(255,181,218,.90);
      border-radius: 999px;
    }
    .starKnob{
      position:absolute;
      top: 50%;
      left: 0%;
      transform: translate(-50%, -50%);
      width: 22px;
      height: 22px;
      background: #ffd7ec;
      border: 2px solid rgba(45,27,39,.58);
      border-radius: 8px;
      clip-path: polygon(50% 5%, 61% 33%, 92% 36%, 68% 56%, 76% 88%, 50% 70%, 24% 88%, 32% 56%, 8% 36%, 39% 33%);
      box-shadow: 0 7px 0 rgba(0,0,0,.07), inset 0 0 0 2px rgba(255,255,255,.55);
      pointer-events:none;
    }

    .playerNote{
      margin: 2px 6px 0;
      font-size: 10.5px;
      color: rgba(108,74,95,.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    @media (max-width: 880px){
      .main{grid-template-columns: 1fr; }
      .side{order:2}
      .window{height: 78vh;}
      .bgText{opacity:.10;}
      .playerMeta{min-width: 180px;}
    }
  </style>
</head>

<body>
  <div class="bgLayer" aria-hidden="true">
    <div class="bgText">
      <div class="t">
        <span class="big">ãã‚…ã‚“â™¡Pixel Diary</span>
        <span class="small">NEKO / PAW / SWEET / RETRO</span>
      </div>
    </div>
    <div id="stickerField"></div>
  </div>

  <div class="container" id="dropZone">
    <div class="window" role="application" aria-label="è¯´è¯´å¡ç‰‡æµè§ˆå™¨çª—å£">
      <div class="titlebar">
        <div class="title-left">
          <div class="pixel-badge">â™¡</div>
          <div class="title-text">
            <b>è¯´è¯´å¡ç‰‡æµè§ˆå™¨ Â· æµ…ç²‰å¤å¤åƒç´ </b>
            <span>é»˜è®¤è‡ªåŠ¨åŠ è½½ï¼šdata.txt + bgm.mp3ï¼ˆåŒç›®å½•ï¼‰</span>
          </div>
          <div class="hearts" aria-hidden="true">
            <div class="heart"></div>
            <div class="heart"></div>
            <div class="heart"></div>
          </div>
        </div>

        <div class="win-btns" aria-hidden="true">
          <div class="winbtn" title="æœ€å°åŒ–">
            <svg viewBox="0 0 24 24"><path d="M6 18h12"/></svg>
          </div>
          <div class="winbtn" title="æœ€å¤§åŒ–">
            <svg viewBox="0 0 24 24"><path d="M7 7h10v10H7z"/></svg>
          </div>
          <div class="winbtn" title="å…³é—­ï¼ˆè£…é¥°ï¼‰">
            <svg viewBox="0 0 24 24"><path d="M7 7l10 10M17 7L7 17"/></svg>
          </div>
        </div>
      </div>

      <div class="main">
        <aside class="side">
          <h3>CONTROL PANEL</h3>

          <div class="stat" id="stat">0 æ¡</div>

          <div class="btn file" role="button" aria-label="å¯¼å…¥txt">
            <span>å¯¼å…¥ TXTï¼ˆå¯é€‰ï¼‰</span>
            <small>æ‹–æ‹½ä¹Ÿè¡Œ</small>
            <input type="file" id="file" accept=".txt,text/plain" />
          </div>

          <button class="btn" id="shuffle">
            <span>éšæœºä¸€æ¡</span><small>R</small>
          </button>

          <button class="btn" id="copy">
            <span>å¤åˆ¶å½“å‰</span><small>COPY</small>
          </button>

          <input class="search" id="search" placeholder="æœç´¢å†…å®¹ / æ—¥æœŸï¼ˆå›è½¦ç¡®è®¤ï¼‰" />

          <button class="btn" id="clear">
            <span>æ¸…é™¤æœç´¢</span><small>CLEAR</small>
          </button>

          <div class="hint" id="hint">
            Tipsï¼š<br>
            1) æ”¾ data.txt åœ¨åŒç›®å½•ä¼šè‡ªåŠ¨è¯»<br>
            2) åŒå‡»èŠå¤©æ¡†å…¨å±<br>
            3) åº•éƒ¨å°æ–¹å—è·³è½¬<br>
            4) éŸ³ä¹è‹¥è¢«æ‹¦æˆªï¼šç‚¹ä¸€æ¬¡æ’­æ”¾
          </div>
        </aside>

        <section class="stage">
          <div class="chatTop">
            <div class="chip"><span class="dot" id="dot"></span><span id="date">æ­£åœ¨åŠ è½½ data.txt ...</span></div>

            <div class="pad">
              <button class="nav" id="prevBtn" aria-label="ä¸Šä¸€æ¡">
                <svg viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6"/></svg>
              </button>
              <div class="chip" id="index">â€”</div>
              <button class="nav" id="nextBtn" aria-label="ä¸‹ä¸€æ¡">
                <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
              </button>
            </div>
          </div>

          <div class="bubbleWrap">
            <div class="bubble" id="bubble" aria-live="polite">
              <div class="content" id="content">
                <small>
                  âœ… è‡ªåŠ¨è¯»å–åŒç›®å½•çš„ <b>data.txt</b><br>
                  âœ… è‡ªåŠ¨æ’­æ”¾åŒç›®å½•çš„ <b>bgm.mp3</b><br><br>
                  å¦‚æœä½ åªæ˜¯åŒå‡»æ‰“å¼€æœ¬åœ° htmlï¼Œéƒ¨åˆ†æµè§ˆå™¨ä¼šé™åˆ¶è¯»å–åŒç›®å½•æ–‡ä»¶ï¼›å»ºè®®ç”¨ Live Server æˆ– python http.server é¢„è§ˆã€‚
                </small>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">
        <div class="dots" id="dots" aria-label="è¿›åº¦"></div>
        <div class="footerRight">
          <div class="mini" id="fullscreen">å…¨å±</div>
          <div style="opacity:.82">Retro Pixel âœ¿ NekoğŸ¾</div>
        </div>
      </div>
    </div>

    <!-- Slim long-bar player -->
    <div class="player" role="region" aria-label="èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨">
      <div class="playerRow">
        <div class="playerMeta">
          <b id="trackName">BGMï¼šæ­£åœ¨åŠ è½½ bgm.mp3 ...</b>
          <span id="trackHint">ï¼ˆå¯å¯¼å…¥éŸ³é¢‘åˆ‡æ¢ï¼‰</span>
        </div>

        <div class="playerBtns" aria-label="æ’­æ”¾å™¨æ§åˆ¶">
          <div class="pbtn" id="prevTrack" title="ä¸Šä¸€é¦–ï¼ˆå¯¼å…¥å¤šé¦–æ—¶å¯ç”¨ï¼‰">
            <svg viewBox="0 0 24 24"><path d="M7 6v12M18 6l-9 6 9 6z"/></svg>
          </div>

          <div class="pbtn play" id="togglePlay" title="æ’­æ”¾ / æš‚åœï¼ˆç©ºæ ¼é”®ä¹Ÿå¯ä»¥ï¼‰">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M9 7l10 5-10 5z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none">
              <path d="M7 6h4v12H7zM13 6h4v12h-4z"/>
            </svg>
          </div>

          <div class="pbtn" id="nextTrack" title="ä¸‹ä¸€é¦–ï¼ˆå¯¼å…¥å¤šé¦–æ—¶å¯ç”¨ï¼‰">
            <svg viewBox="0 0 24 24"><path d="M17 6v12M6 6l9 6-9 6z"/></svg>
          </div>

          <div class="playerHearts" aria-hidden="true">
            <div class="pheart"></div><div class="pheart"></div><div class="pheart"></div>
          </div>
        </div>

        <label class="importBtn">
          å¯¼å…¥éŸ³ä¹ï¼ˆå¯å¤šé€‰ï¼‰
          <input type="file" id="audioFile" accept="audio/*" multiple />
        </label>
      </div>

      <div class="autoplayInline" id="autoplayInline">
        âš ï¸ æµè§ˆå™¨å¯èƒ½ä¼šæ‹¦æˆªâ€œè‡ªåŠ¨æ’­æ”¾å¸¦å£°éŸ³â€ã€‚ç‚¹ä¸€æ¬¡ã€Œæ’­æ”¾ã€å°±å¥½ï¼ˆä¹‹åé€šå¸¸ä¼šè®°ä½å…è®¸ï¼‰ã€‚
      </div>

      <div class="progressRow">
        <div class="ptime" id="curTime">0:00</div>
        <div class="bar" id="bar">
          <div class="barFill" id="barFill"></div>
          <div class="starKnob" id="starKnob"></div>
        </div>
        <div class="ptime" id="durTime">0:00</div>
      </div>

      <div class="playerNote" id="playerNote">æç¤ºï¼šæŠŠ bgm.mp3 æ”¾åœ¨åŒç›®å½•ï¼Œä¼šè‡ªåŠ¨åŠ è½½</div>
      <audio id="audio" preload="auto" loop></audio>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // ======= TXT viewer =======
    const els = {
      file: $("#file"),
      bubble: $("#bubble"),
      date: $("#date"),
      content: $("#content"),
      index: $("#index"),
      stat: $("#stat"),
      dots: $("#dots"),
      prev: $("#prevBtn"),
      next: $("#nextBtn"),
      shuffle: $("#shuffle"),
      copy: $("#copy"),
      search: $("#search"),
      clear: $("#clear"),
      fullscreen: $("#fullscreen"),
      dot: $("#dot"),
      hint: $("#hint"),
    };

    let entries = [];
    let view = [];
    let current = 0;

    function parseTxt(raw){
      const txt = String(raw || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n").trim();
      if(!txt) return [];

      const re = /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥\s+\d{2}:\d{2}:\d{2})/g;
      const matches = [...txt.matchAll(re)];

      if(matches.length === 0){
        return txt
          .split(/\n{2,}/)
          .map(s => s.trim())
          .filter(Boolean)
          .map((body, i) => ({ id: i+1, date: "", body }));
      }

      const out = [];
      for(let i=0; i<matches.length; i++){
        const start = matches[i].index;
        const end = (i+1 < matches.length) ? matches[i+1].index : txt.length;
        const block = txt.slice(start, end).trim();
        const date = matches[i][1].trim();

        let body = block.replace(re, "").trim();
        body = body.replace(/^[\s\n]+/, "").replace(/[\s\n]+$/, "");
        out.push({ id: i+1, date, body });
      }
      return out;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function formatBody(body){
      const safe = escapeHTML(body);
      return safe.replaceAll("\n", "<br>");
    }

    function setStat(){
      els.stat.textContent = `${view.length} æ¡` + (entries.length !== view.length ? `ï¼ˆç­›é€‰è‡ª ${entries.length} æ¡ï¼‰` : "");
    }

    function buildDots(){
      els.dots.innerHTML = "";
      const maxDots = 70;
      const n = view.length;
      if(n <= 1) return;

      const count = Math.min(n, maxDots);
      for(let i=0; i<count; i++){
        const btn = document.createElement("button");
        btn.className = "dotbtn";
        btn.title = n <= maxDots ? `ç¬¬ ${i+1} æ¡` : `è·³è½¬`;
        btn.addEventListener("click", () => {
          const target = (n <= maxDots) ? i : Math.round(i * (n-1) / (count-1));
          go(target, target > current ? "right" : "left");
        });
        els.dots.appendChild(btn);
      }
      updateDots();
    }

    function updateDots(){
      const dots = [...els.dots.querySelectorAll(".dotbtn")];
      if(!dots.length) return;

      const n = view.length;
      const maxDots = dots.length;
      let activeIdx = 0;
      if(n <= maxDots){
        activeIdx = current;
      }else{
        activeIdx = Math.round(current * (maxDots-1) / (n-1));
      }
      dots.forEach((d, i) => d.classList.toggle("active", i === activeIdx));
    }

    function setNavState(){
      const disabled = view.length <= 1;
      els.prev.toggleAttribute("disabled", disabled);
      els.next.toggleAttribute("disabled", disabled);
    }

    function pickDotColor(date){
      const s = date || "no-date";
      let h = 0;
      for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
      const hue = (h % 360);
      els.dot.style.background = `hsla(${hue}, 68%, 64%, .95)`;
    }

    function render(direction){
      if(view.length === 0){
        els.date.textContent = "æ²¡æœ‰å¯å±•ç¤ºçš„è®°å½•";
        els.index.textContent = "â€”";
        els.content.innerHTML = "<small>æ²¡è¯»åˆ° data.txtï¼šè¯·æŠŠ data.txt æ”¾åœ¨åŒç›®å½•ï¼Œæˆ–ç‚¹å‡»å·¦ä¾§å¯¼å…¥ txtã€‚</small>";
        els.dots.innerHTML = "";
        setNavState();
        setStat();
        return;
      }

      const item = view[current];
      setNavState();
      setStat();

      const outClass = direction === "right" ? "out-left" : direction === "left" ? "out-right" : "";
      const inClass  = direction === "right" ? "in-right"  : direction === "left" ? "in-left"  : "";

      if(outClass) els.bubble.classList.add(outClass);

      window.setTimeout(() => {
        els.date.textContent = item.date || "ï¼ˆæ— æ—¶é—´æˆ³ï¼‰";
        els.index.textContent = `${current + 1} / ${view.length}`;
        els.content.innerHTML = formatBody(item.body || "ï¼ˆç©ºï¼‰");
        pickDotColor(item.date);
        updateDots();
        els.bubble.scrollTop = 0;

        if(outClass){
          els.bubble.classList.remove(outClass);
          els.bubble.classList.add(inClass);
          window.requestAnimationFrame(() => els.bubble.classList.remove(inClass));
        }
      }, outClass ? 90 : 0);
    }

    function go(idx, direction){
      if(view.length === 0) return;
      current = (idx + view.length) % view.length;
      render(direction);
    }
    function next(){ go(current + 1, "right"); }
    function prev(){ go(current - 1, "left"); }

    function applyFilter(q){
      const query = (q || "").trim().toLowerCase();
      if(!query){
        view = [...entries];
        current = Math.min(current, view.length - 1);
        buildDots();
        render();
        return;
      }
      view = entries.filter(e => (e.date + "\n" + e.body).toLowerCase().includes(query));
      current = 0;
      buildDots();
      render();
    }

    async function loadTxtFile(file){
      const text = await file.text();
      entries = parseTxt(text);
      view = [...entries];
      current = 0;
      buildDots();
      render();
      els.hint.innerHTML = `å·²å¯¼å…¥ï¼š<b>${escapeHTML(file.name)}</b><br>å…± ${entries.length} æ¡`;
    }

    async function loadTxtFromUrl(url){
      try{
        const res = await fetch(url, { cache: "no-cache" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        entries = parseTxt(text);
        view = [...entries];
        current = 0;
        buildDots();
        render();
        els.hint.innerHTML = `å·²è‡ªåŠ¨è¯»å–ï¼š<b>${escapeHTML(url)}</b><br>å…± ${entries.length} æ¡`;
      }catch{
        els.date.textContent = "æ²¡æœ‰æ‰¾åˆ° data.txt";
        els.index.textContent = "â€”";
        els.content.innerHTML = "<small>æˆ‘æ²¡èƒ½è‡ªåŠ¨è¯»å–åŒç›®å½•çš„ <b>data.txt</b>ã€‚<br>è§£å†³ï¼šæŠŠä½ çš„ txt æ–‡ä»¶å‘½åä¸º <b>data.txt</b> æ”¾åœ¨åŒç›®å½•ï¼Œæˆ–ç”¨å·¦ä¾§æŒ‰é’®æ‰‹åŠ¨å¯¼å…¥ã€‚</small>";
        setStat();
      }
    }

    els.file.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) await loadTxtFile(file);
      e.target.value = "";
    });

    ["dragenter","dragover"].forEach(evt => {
      document.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    document.addEventListener("drop", async (e) => {
      e.preventDefault(); e.stopPropagation();
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!file) return;
      if(file.type.startsWith("text/") || file.name.toLowerCase().endsWith(".txt")){
        await loadTxtFile(file);
      }
    });

    els.prev.addEventListener("click", prev);
    els.next.addEventListener("click", next);
    els.shuffle.addEventListener("click", () => {
      if(view.length <= 1) return;
      const r = Math.floor(Math.random() * view.length);
      go(r, r > current ? "right" : "left");
    });

    els.copy.addEventListener("click", async () => {
      if(view.length === 0) return;
      const item = view[current];
      const text = (item.date ? item.date + "\n" : "") + item.body;
      try{
        await navigator.clipboard.writeText(text);
        els.hint.textContent = "å·²å¤åˆ¶å½“å‰å†…å®¹â™¡";
      }catch{
        els.hint.textContent = "å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨é™åˆ¶ï¼ˆå¯æ‰‹åŠ¨é€‰ä¸­å¤åˆ¶ï¼‰";
      }
      setTimeout(() => {
        els.hint.innerHTML = "Tipsï¼š<br>1) æ”¾ data.txt åœ¨åŒç›®å½•ä¼šè‡ªåŠ¨è¯»<br>2) åŒå‡»èŠå¤©æ¡†å…¨å±<br>3) åº•éƒ¨å°æ–¹å—è·³è½¬<br>4) éŸ³ä¹è‹¥è¢«æ‹¦æˆªï¼šç‚¹ä¸€æ¬¡æ’­æ”¾";
      }, 1400);
    });

    els.search.addEventListener("keydown", (e) => {
      if(e.key === "Enter") applyFilter(els.search.value);
    });
    els.clear.addEventListener("click", () => {
      els.search.value = "";
      applyFilter("");
    });

    async function toggleFullscreen(){
      try{
        const win = document.querySelector(".window");
        if(!document.fullscreenElement) await win.requestFullscreen();
        else await document.exitFullscreen();
      }catch{}
    }
    els.fullscreen.addEventListener("click", toggleFullscreen);
    els.bubble.addEventListener("dblclick", toggleFullscreen);

    window.addEventListener("keydown", (e) => {
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key === "Escape" && document.fullscreenElement) document.exitFullscreen();
      if(e.key.toLowerCase() === "r") { e.preventDefault(); els.shuffle.click(); }
      if(e.key === " "){ e.preventDefault(); $("#togglePlay").click(); }
    });

    // swipe
    let startX = 0, startY = 0, moved = false;
    els.bubble.addEventListener("pointerdown", (e) => {
      startX = e.clientX; startY = e.clientY; moved = false;
      els.bubble.setPointerCapture(e.pointerId);
    });
    els.bubble.addEventListener("pointermove", (e) => {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if(Math.abs(dx) > 12 && Math.abs(dx) > Math.abs(dy)) moved = true;
    });
    els.bubble.addEventListener("pointerup", (e) => {
      const dx = e.clientX - startX;
      if(!moved) return;
      if(dx < -55) next();
      if(dx > 55) prev();
    });

    // ======= Decorations: richer + no overlap =======
    const stickerField = $("#stickerField");
    const spriteClasses = ["i-star","i-bow","i-cassette","i-paw","i-sakura","i-gummy","i-heart","i-lightning","i-candy","i-cd","i-strawberry","i-sparkle"];

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function rectsOverlap(a, b, pad=6){
      return !(
        a.x + a.w + pad < b.x ||
        b.x + b.w + pad < a.x ||
        a.y + a.h + pad < b.y ||
        b.y + b.h + pad < a.y
      );
    }

    function spawnStickers(){
      stickerField.innerHTML = "";
      const W = window.innerWidth;
      const H = window.innerHeight;

      // edge bands (px)
      const band = Math.max(110, Math.min(160, Math.floor(Math.min(W,H) * 0.18)));
      const placed = [];

      const target = Math.min(78, Math.max(48, Math.floor((W * H) / 30000))); // richer
      for(let i=0; i<target; i++){
        const size = rand(36, 86);
        const rot = rand(-18, 18);

        // pick a band region
        const region = pick(["top","bottom","left","right","top","bottom"]); // bias top/bottom
        const tries = 70;

        let x=0, y=0;
        let ok = false;

        for(let t=0; t<tries; t++){
          if(region === "top"){
            x = rand(8, W - size - 8);
            y = rand(8, band - size);
          }else if(region === "bottom"){
            x = rand(8, W - size - 8);
            y = rand(H - band, H - size - 8);
          }else if(region === "left"){
            x = rand(8, band - size);
            y = rand(band, H - band - size);
          }else{
            x = rand(W - band, W - size - 8);
            y = rand(band, H - band - size);
          }

          const r = {x, y, w:size, h:size};
          let overlap = false;
          for(const p of placed){
            if(rectsOverlap(r, p, 8)){ overlap = true; break; }
          }
          if(!overlap){
            placed.push(r);
            ok = true;
            break;
          }
        }

        if(!ok){
          // as a last resort, place but still in band
          placed.push({x, y, w:size, h:size});
        }

        const s = document.createElement("div");
        s.className = "sticker";
        s.style.width = size + "px";
        s.style.height = size + "px";
        s.style.left = x + "px";
        s.style.top  = y + "px";
        s.style.setProperty("--rot", rot.toFixed(1) + "deg");
        s.style.opacity = (0.72 + Math.random()*0.22).toFixed(2);

        const inner = document.createElement("div");
        inner.className = "sprite " + pick(spriteClasses);
        s.appendChild(inner);
        stickerField.appendChild(s);
      }
    }

    window.addEventListener("resize", () => {
      clearTimeout(window.__stickerTimer);
      window.__stickerTimer = setTimeout(spawnStickers, 180);
    });

    // ======= Music player =======
    const audio = $("#audio");
    const audioFile = $("#audioFile");
    const togglePlayBtn = $("#togglePlay");
    const playIcon = $("#playIcon");
    const pauseIcon = $("#pauseIcon");
    const prevTrackBtn = $("#prevTrack");
    const nextTrackBtn = $("#nextTrack");
    const bar = $("#bar");
    const barFill = $("#barFill");
    const starKnob = $("#starKnob");
    const curTime = $("#curTime");
    const durTime = $("#durTime");
    const trackName = $("#trackName");
    const trackHint = $("#trackHint");
    const playerNote = $("#playerNote");
    const autoplayInline = $("#autoplayInline");

    let playlist = [];
    let trackIndex = 0;

    function fmtTime(sec){
      if(!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function setPlayingUI(isPlaying){
      playIcon.style.display = isPlaying ? "none" : "block";
      pauseIcon.style.display = isPlaying ? "block" : "none";
    }

    async function tryPlay(){
      try{
        const p = audio.play();
        if(p && p.then) await p;
        setPlayingUI(true);
        autoplayInline.style.display = "none";
      }catch{
        setPlayingUI(false);
        autoplayInline.style.display = "block";
      }
    }

    function loadTrack(i, autoplay=true){
      if(!playlist.length){
        trackName.textContent = "BGMï¼šæœªåŠ è½½";
        trackHint.textContent = "æŠŠ bgm.mp3 æ”¾åŒç›®å½•ï¼Œæˆ–ç”¨â€œå¯¼å…¥éŸ³ä¹â€";
        playerNote.textContent = "æç¤ºï¼šGitHub Pages ä¸ŠåŒç›®å½•æ–‡ä»¶å¯ç›´æ¥å¼•ç”¨";
        audio.removeAttribute("src");
        setPlayingUI(false);
        return;
      }
      trackIndex = (i + playlist.length) % playlist.length;
      const t = playlist[trackIndex];
      audio.src = t.url;
      audio.loop = true;
      trackName.textContent = "BGMï¼š" + t.name;
      trackHint.textContent = (playlist.length > 1) ? `ç¬¬ ${trackIndex+1}/${playlist.length} é¦–ï¼ˆå¯åˆ‡æ¢ï¼‰` : "ç‚¹å‡»æ’­æ”¾/æš‚åœå³å¯";
      playerNote.textContent = "ç©ºæ ¼é”®æ’­æ”¾/æš‚åœ Â· ç‚¹å‡»è¿›åº¦æ¡è·³è½¬";
      if(autoplay) tryPlay();
    }

    async function loadAudioFiles(files){
      playlist.forEach(t => { if(t.url && t.url.startsWith("blob:")) URL.revokeObjectURL(t.url); });
      playlist = files.map(f => ({ name: f.name, url: URL.createObjectURL(f) }));
      loadTrack(0, true);
    }

    audioFile.addEventListener("change", async (e) => {
      const files = [...(e.target.files || [])].filter(f => f.type.startsWith("audio/"));
      if(files.length) await loadAudioFiles(files);
      e.target.value = "";
    });

    togglePlayBtn.addEventListener("click", async () => {
      if(!audio.src) audio.src = "bgm.mp3";
      if(audio.paused) await tryPlay();
      else { audio.pause(); setPlayingUI(false); }
    });

    prevTrackBtn.addEventListener("click", () => {
      if(playlist.length > 1) loadTrack(trackIndex - 1, true);
    });
    nextTrackBtn.addEventListener("click", () => {
      if(playlist.length > 1) loadTrack(trackIndex + 1, true);
    });

    audio.addEventListener("timeupdate", () => {
      const cur = audio.currentTime || 0;
      const dur = audio.duration || 0;
      curTime.textContent = fmtTime(cur);
      durTime.textContent = isFinite(dur) ? fmtTime(dur) : "0:00";
      const p = (dur > 0) ? (cur / dur) : 0;
      barFill.style.width = (p * 100) + "%";
      starKnob.style.left = (p * 100) + "%";
    });

    function seekByClientX(clientX){
      const rect = bar.getBoundingClientRect();
      const x = Math.min(rect.right, Math.max(rect.left, clientX));
      const p = (x - rect.left) / rect.width;
      const dur = audio.duration || 0;
      if(dur > 0) audio.currentTime = p * dur;
    }
    bar.addEventListener("click", (e) => seekByClientX(e.clientX));

    async function tryLoadDefaultBgm(){
      audio.src = "bgm.mp3";
      audio.loop = true;
      trackName.textContent = "BGMï¼šbgm.mp3ï¼ˆé»˜è®¤ï¼‰";
      trackHint.textContent = "è‹¥è¢«æµè§ˆå™¨æ‹¦æˆªè‡ªåŠ¨æ’­æ”¾ï¼Œç‚¹ä¸€æ¬¡æ’­æ”¾å³å¯";
      playerNote.textContent = "ä½ ä¹Ÿå¯ä»¥å¯¼å…¥è‡ªå·±çš„éŸ³é¢‘æ›¿æ¢/åˆ‡æ­Œ";
      await tryPlay();
    }

    audio.addEventListener("error", () => {
      if(audio.src && audio.src.endsWith("bgm.mp3") && !playlist.length){
        trackName.textContent = "BGMï¼šæœªæ‰¾åˆ° bgm.mp3";
        trackHint.textContent = "æŠŠéŸ³é¢‘æ”¾åŒç›®å½•å¹¶å‘½å bgm.mp3ï¼Œæˆ–ç‚¹â€œå¯¼å…¥éŸ³ä¹â€";
        playerNote.textContent = "è¯´æ˜ï¼šGitHub Pages ä¸ŠåŒç›®å½•æ–‡ä»¶å¯ç›´æ¥å¼•ç”¨";
        setPlayingUI(false);
      }
    });

    async function loadTxtFromUrl(url){
      try{
        const res = await fetch(url, { cache: "no-cache" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        entries = parseTxt(text);
        view = [...entries];
        current = 0;
        buildDots();
        render();
        els.hint.innerHTML = `å·²è‡ªåŠ¨è¯»å–ï¼š<b>${escapeHTML(url)}</b><br>å…± ${entries.length} æ¡`;
      }catch{
        els.date.textContent = "æ²¡æœ‰æ‰¾åˆ° data.txt";
        els.index.textContent = "â€”";
        els.content.innerHTML = "<small>æˆ‘æ²¡èƒ½è‡ªåŠ¨è¯»å–åŒç›®å½•çš„ <b>data.txt</b>ã€‚<br>è§£å†³ï¼šæŠŠä½ çš„ txt æ–‡ä»¶å‘½åä¸º <b>data.txt</b> æ”¾åœ¨åŒç›®å½•ï¼Œæˆ–ç”¨å·¦ä¾§æŒ‰é’®æ‰‹åŠ¨å¯¼å…¥ã€‚</small>";
        setStat();
      }
    }

    // init
    spawnStickers();
    render();
    loadTxtFromUrl("data.txt");
    tryLoadDefaultBgm();
  </script>
</body>
</html>
